<!-- app shell -->
<app-header />

<!-- global tab bar -->
<div class="global-tab-bar">
  <div class="tab-list">
    @for (tab of tabs; track tab.id) {
      <div
        class="tab"
        [class.active]="tab.id === activeTabId"
        [class.pinned]="tab.pinned"
        (click)="activateTab(tab.id)"
        [title]="tab.label"
      >
        <span class="tab-icon">
          @if (tab.type === "rack") {
            üñ•Ô∏è
          } @else if (tab.type === "room") {
            üó∫Ô∏è
          } @else {
            üè†
          }
        </span>
        <span class="tab-label">{{ tab.label }}</span>
        @if (!tab.pinned) {
          <button
            class="tab-close"
            (click)="closeTab(tab.id, $event)"
            title="Chiudi scheda"
          >
            √ó
          </button>
        }
      </div>
    }
  </div>
</div>

<!-- content area -->
<div class="app-content">
  <!-- Home pane: deferred on idle (lazy chunk), kept alive with [hidden] -->
  <div class="content-pane home-pane" [hidden]="activeTabId !== 'home'">
    @defer (on idle) {
      <app-home />
    } @placeholder {
      <div class="loading-state">Caricamento‚Ä¶</div>
    }
  </div>

  <!-- Room panes: lazy chunk loaded on first tab activation, state preserved by [hidden] -->
  @for (tab of tabService.tabs(); track tab.id) {
    @if (tab.type === "room") {
      <div class="content-pane" [hidden]="activeTabId !== tab.id">
        @defer (when activeTabId === tab.id; prefetch on idle) {
          <app-map [roomId]="tab.roomId" />
        } @placeholder {
          <div class="loading-state">Apertura room‚Ä¶</div>
        }
      </div>
    }
  }

  <!-- Rack panes: lazy chunk, recreated when tab is active -->
  @for (tab of tabService.tabs(); track tab.id) {
    @if (tab.type === "rack" && activeTabId === tab.id) {
      <div class="content-pane rack-pane">
        @if (tabService.loadingRackTabId() === tab.id) {
          <div class="loading-state">Caricamento rack‚Ä¶</div>
        } @else if (tabService.getRack(tab.id)) {
          @defer (on immediate) {
            <app-rack [rack]="tabService.getRack(tab.id)!" />
          } @placeholder {
            <div class="loading-state">Caricamento rack‚Ä¶</div>
          }
        } @else {
          <div class="loading-state">Rack non trovato.</div>
        }
      </div>
    }
  }
</div>
