<div class="rack-view" [style.--u-height]="uHeightCss()">
  <!-- Toast: move error -->
  @if (_moveError()) {
    <div class="rack-toast rack-toast--error">{{ _moveError() }}</div>
  }

  <!-- ── Left column: rack chassis only ──────────────────────── -->
  <div class="rack-col">
    <!-- Chassis -->
    <div
      class="rack-chassis"
      [class.rack-chassis--saving]="_saving()"
      [class.rack-chassis--rear]="_rearView()"
    >
      <div class="rack-panel rack-panel--top">
        <span class="rack-panel__screw"></span>
        <span class="rack-panel__label">{{ rack()?.name }}</span>
        <span class="rack-panel__screw"></span>
      </div>

      <div class="rack-units">
        @if (loading()) {
          @for (i of skeletonRows(); track i) {
            <div class="rack-row rack-row--skeleton" [style.--u-span]="1">
              <div class="rack-u-num"></div>
              <div class="rack-slot rack-slot--skeleton"></div>
              <div class="rack-u-num rack-u-num--r"></div>
            </div>
          }
        } @else if (error()) {
          <div class="rack-error">
            <svg
              viewBox="0 0 20 20"
              fill="currentColor"
              class="rack-error__icon"
            >
              <path
                fill-rule="evenodd"
                d="M8.485 2.495c.673-1.167 2.357-1.167 3.03 0l6.28 10.875c.673 1.167-.17 2.625-1.516 2.625H3.72c-1.347 0-2.189-1.458-1.515-2.625L8.485 2.495zM10 5a.75.75 0 01.75.75v3.5a.75.75 0 01-1.5 0v-3.5A.75.75 0 0110 5zm0 9a1 1 0 100-2 1 1 0 000 2z"
                clip-rule="evenodd"
              />
            </svg>
            <span>{{ "rack.error_loading" | translate }}</span>
          </div>
        } @else {
          @for (row of rackRender(); track row.position) {
            @if (row.visible || _dragging()) {
              <div
                class="rack-row"
                [class.rack-row--occupied]="!!row.device"
                [class.rack-row--dragging]="_dragging()?.id === row.device?.id"
                [class.rack-row--drop-valid]="
                  isInDropSpan(row.position) && canDropAt(_dropTarget())
                "
                [class.rack-row--drop-invalid]="
                  isInDropSpan(row.position) && !canDropAt(_dropTarget())
                "
                [class.rack-row--ghost-target]="!row.visible && !!_dragging()"
                [style.--u-span]="
                  row.device && !_dragging() ? row.device.device_rack_units : 1
                "
                (dragover)="onDragOver($event, row.position)"
                (dragleave)="onDragLeave($event)"
                (drop)="onDrop($event, row.position)"
              >
                <div class="rack-u-num">{{ row.position }}</div>
                <div class="rack-slot">
                  @if (row.device) {
                    <div
                      class="rack-slot__occupied"
                      draggable="true"
                      (dragstart)="onDragStart($event, row.device)"
                      (dragend)="onDragEnd()"
                    >
                      <app-device
                        [device]="row.device"
                        [position]="row.position"
                        [rearView]="_rearView()"
                      />
                    </div>
                  } @else {
                    <div
                      class="rack-slot__empty"
                      (click)="openInstall(row.position, $event)"
                    >
                      <span class="rack-slot__rail rack-slot__rail--l"></span>
                      <span class="rack-slot__install-hint">+</span>
                      <span class="rack-slot__rail rack-slot__rail--r"></span>
                    </div>
                  }
                </div>
                <div class="rack-u-num rack-u-num--r">{{ row.position }}</div>
              </div>
            }
          }
        }
      </div>
      <!-- /rack-units -->

      <div class="rack-panel rack-panel--bottom">
        <span class="rack-panel__screw"></span>
        <span class="rack-panel__screw"></span>
      </div>
    </div>
    <!-- /rack-chassis -->
  </div>
  <!-- /rack-col -->

  <!-- ── Right column: rack info + device table ──────────────── -->
  <div class="rack-aside">
    <!-- Rack header: always visible -->
    <div class="rack-header">
      <div class="rack-header__top">
        <span class="rack-header__name">{{ rack()?.name ?? "—" }}</span>
        @if (rack()?.location_name) {
          <span class="rack-header__location">{{ rack()?.location_name }}</span>
        }
        <div class="rack-face-toggle">
          <button
            class="rack-face-toggle__btn"
            [class.rack-face-toggle__btn--active]="!_rearView()"
            (click)="_rearView.set(false)"
            [title]="'rack.front_view' | translate"
          >
            {{ "rack.front" | translate }}
          </button>
          <button
            class="rack-face-toggle__btn"
            [class.rack-face-toggle__btn--active]="_rearView()"
            (click)="_rearView.set(true)"
            [title]="'rack.rear_view' | translate"
          >
            {{ "rack.rear" | translate }}
          </button>
        </div>
      </div>
      @if (rack() && !loading()) {
        <div class="rack-header__stats">
          <div class="rack-stat">
            <span class="rack-stat__value">{{ rack()!.model.capacity }}</span>
            <span class="rack-stat__label">{{
              "rack.stat_total" | translate
            }}</span>
          </div>
          <div class="rack-stat rack-stat--used">
            <span class="rack-stat__value">{{ occupiedUnits() }}</span>
            <span class="rack-stat__label">{{
              "rack.stat_used" | translate
            }}</span>
          </div>
          <div class="rack-stat rack-stat--free">
            <span class="rack-stat__value">{{ freeUnits() }}</span>
            <span class="rack-stat__label">{{
              "rack.stat_free" | translate
            }}</span>
          </div>
          <div class="rack-stat rack-stat--power">
            <span class="rack-stat__value"
              >{{ totalPowerKw() }}<small> kW</small></span
            >
            <span class="rack-stat__label">{{
              "rack.stat_power" | translate
            }}</span>
          </div>
          <div class="rack-stat rack-stat--ampere">
            <span class="rack-stat__value"
              >{{ totalPowerAmpere() }}<small> A</small></span
            >
            <span class="rack-stat__label">{{
              "rack.stat_ampere" | translate
            }}</span>
          </div>
        </div>
      }
    </div>

    <!-- Device table: visible only when data is ready -->
    @if (!loading() && !error() && deviceRows().length) {
      <app-rack-device-table
        [rows]="deviceRows()"
        [clearTrigger]="_refresh()"
        [availableStatesCount]="availableStates().length"
        (removeRequest)="onRemoveRequest($event)"
        (statePickerRequest)="onStatePickerRequest($event)"
        (bulkRemoveRequest)="onBulkRemoveRequest($event)"
      />
    }
  </div>
  <!-- /rack-aside -->

  <!-- ── Install panel ──────────────────────────────────────── -->
  @if (_installPos() && rack()) {
    <app-rack-install-panel
      [position]="_installPos()!"
      [anchorX]="_installAnchorX()"
      [anchorY]="_installAnchorY()"
      [rackId]="rack()!.id"
      [availableU]="_installAvailableU()"
      (closed)="closeInstall()"
      (installed)="onInstalled()"
    />
  }
</div>
<!-- /rack-view -->

<!-- ── Bulk remove confirmation modal ─────────────────────── -->
@if (_bulkRemoveConfirm()) {
  <app-rack-remove-confirm
    mode="bulk"
    [bulkRackUnitIds]="_bulkRUIdsForConfirm()"
    [bulkAssetIds]="_bulkAssetIdsForConfirm()"
    [selectedCount]="_bulkRUIdsForConfirm().length"
    [decommissionedStateId]="decommissionedStateId()"
    (confirmed)="onBulkRemoveConfirmed()"
    (closed)="closeBulkRemoveConfirm()"
  />
}

<!-- ── Remove confirmation popover ─────────────────────── -->
@if (_removeConfirmId()) {
  <app-rack-remove-confirm
    mode="single"
    [rackUnitId]="_removeConfirmId()!"
    [assetId]="_removeConfirmAssetId()"
    [anchorX]="_removeConfirmX()"
    [anchorY]="_removeConfirmY()"
    [decommissionedStateId]="decommissionedStateId()"
    (confirmed)="onSingleRemoveConfirmed()"
    (closed)="closeRemoveConfirm()"
  />
}

<!-- ── State picker popover ───────────────────────────────────── -->
@if (_statePickerDeviceId()) {
  <app-rack-state-picker
    [states]="availableStates()"
    [anchorX]="_statePickerX()"
    [anchorY]="_statePickerY()"
    [deviceId]="_statePickerDeviceId()!"
    (stateChanged)="refreshRack()"
    (closed)="closeStatePicker()"
  />
}
