<div class="rack-view" [style.--u-height]="uHeightCss()">
  <!-- Toast: move error -->
  @if (_moveError()) {
    <div class="rack-toast rack-toast--error">{{ _moveError() }}</div>
  }

  <!-- ── Left column: rack chassis only ──────────────────────── -->
  <div class="rack-col">
    <!-- Chassis -->
    <div class="rack-chassis" [class.rack-chassis--saving]="_saving()">
      <div class="rack-panel rack-panel--top">
        <span class="rack-panel__screw"></span>
        <span class="rack-panel__label">{{ rack()?.name }}</span>
        <span class="rack-panel__screw"></span>
      </div>

      <div class="rack-units">
        @if (loading()) {
          @for (i of skeletonRows(); track i) {
            <div class="rack-row rack-row--skeleton" [style.--u-span]="1">
              <div class="rack-u-num"></div>
              <div class="rack-slot rack-slot--skeleton"></div>
              <div class="rack-u-num rack-u-num--r"></div>
            </div>
          }
        } @else if (error()) {
          <div class="rack-error">
            <svg
              viewBox="0 0 20 20"
              fill="currentColor"
              class="rack-error__icon"
            >
              <path
                fill-rule="evenodd"
                d="M8.485 2.495c.673-1.167 2.357-1.167 3.03 0l6.28 10.875c.673 1.167-.17 2.625-1.516 2.625H3.72c-1.347 0-2.189-1.458-1.515-2.625L8.485 2.495zM10 5a.75.75 0 01.75.75v3.5a.75.75 0 01-1.5 0v-3.5A.75.75 0 0110 5zm0 9a1 1 0 100-2 1 1 0 000 2z"
                clip-rule="evenodd"
              />
            </svg>
            <span>Errore nel caricamento delle unità rack</span>
          </div>
        } @else {
          @for (row of rackRender(); track row.position) {
            @if (row.visible || _dragging()) {
              <div
                class="rack-row"
                [class.rack-row--occupied]="!!row.device"
                [class.rack-row--dragging]="_dragging()?.id === row.device?.id"
                [class.rack-row--drop-valid]="
                  isInDropSpan(row.position) && canDropAt(_dropTarget())
                "
                [class.rack-row--drop-invalid]="
                  isInDropSpan(row.position) && !canDropAt(_dropTarget())
                "
                [class.rack-row--ghost-target]="!row.visible && !!_dragging()"
                [style.--u-span]="
                  row.device && !_dragging() ? row.device.device_rack_units : 1
                "
                (dragover)="onDragOver($event, row.position)"
                (dragleave)="onDragLeave($event)"
                (drop)="onDrop($event, row.position)"
              >
                <div class="rack-u-num">{{ row.position }}</div>
                <div class="rack-slot">
                  @if (row.device) {
                    <div
                      class="rack-slot__occupied"
                      draggable="true"
                      (dragstart)="onDragStart($event, row.device)"
                      (dragend)="onDragEnd()"
                    >
                      <app-device
                        [device]="row.device"
                        [position]="row.position"
                      />
                    </div>
                  } @else {
                    <div
                      class="rack-slot__empty"
                      (click)="openInstall(row.position, $event)"
                    >
                      <span class="rack-slot__rail rack-slot__rail--l"></span>
                      <span class="rack-slot__install-hint">+</span>
                      <span class="rack-slot__rail rack-slot__rail--r"></span>
                    </div>
                  }
                </div>
                <div class="rack-u-num rack-u-num--r">{{ row.position }}</div>
              </div>
            }
          }
        }
      </div>
      <!-- /rack-units -->

      <div class="rack-panel rack-panel--bottom">
        <span class="rack-panel__screw"></span>
        <span class="rack-panel__screw"></span>
      </div>
    </div>
    <!-- /rack-chassis -->
  </div>
  <!-- /rack-col -->

  <!-- ── Right column: rack info + device table ──────────────── -->
  <div class="rack-aside">
    <!-- Rack header: always visible -->
    <div class="rack-header">
      <div class="rack-header__top">
        <span class="rack-header__name">{{ rack()?.name ?? "—" }}</span>
        @if (rack()?.location_name) {
          <span class="rack-header__location">{{ rack()?.location_name }}</span>
        }
      </div>
      @if (rack() && !loading()) {
        <div class="rack-header__stats">
          <div class="rack-stat">
            <span class="rack-stat__value">{{ rack()!.model.capacity }}</span>
            <span class="rack-stat__label">Unità totali</span>
          </div>
          <div class="rack-stat rack-stat--used">
            <span class="rack-stat__value">{{ occupiedUnits() }}</span>
            <span class="rack-stat__label">Occupate</span>
          </div>
          <div class="rack-stat rack-stat--free">
            <span class="rack-stat__value">{{ freeUnits() }}</span>
            <span class="rack-stat__label">Libere</span>
          </div>
          <div class="rack-stat rack-stat--power">
            <span class="rack-stat__value"
              >{{ totalPowerKw() }}<small> kW</small></span
            >
            <span class="rack-stat__label">Potenza</span>
          </div>
          <div class="rack-stat rack-stat--ampere">
            <span class="rack-stat__value"
              >{{ totalPowerAmpere() }}<small> A</small></span
            >
            <span class="rack-stat__label">Corrente</span>
          </div>
        </div>
      }
    </div>

    <!-- Device table: visible only when data is ready -->
    @if (!loading() && !error() && deviceRows().length) {
      <div class="rack-aside__header">
        <span class="rack-aside__title">Apparati installati</span>
        <span class="rack-aside__count">{{ deviceRows().length }}</span>
      </div>

      @if (selectedCount() > 0) {
        <div class="device-table__bulk-bar">
          <span class="device-table__bulk-bar__info"
            >{{ selectedCount() }}
            {{ selectedCount() === 1 ? "selezionato" : "selezionati" }}</span
          >
          <div class="device-table__bulk-bar__actions">
            <button
              class="device-table__bulk-btn device-table__bulk-btn--remove"
              (click)="openBulkRemoveConfirm()"
            >
              <svg viewBox="0 0 16 16" fill="currentColor" width="12" height="12">
                <path d="M6.5 1h3a.5.5 0 0 1 .5.5v1H6v-1a.5.5 0 0 1 .5-.5ZM11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3A1.5 1.5 0 0 0 5 1.5v1H2.506a.58.58 0 0 0-.01 0H1.5a.5.5 0 0 0 0 1h.538l.853 10.66A2 2 0 0 0 4.885 16h6.23a2 2 0 0 0 1.994-1.84l.853-10.66H13.5a.5.5 0 0 0 0-1h-.995a.59.59 0 0 0-.01 0H11Zm1.958 1-.846 10.58a1 1 0 0 1-.997.92h-6.23a1 1 0 0 1-.997-.92L3.042 3.5h9.916Z"/>
              </svg>
              Rimuovi dal rack
            </button>
            <button
              class="device-table__bulk-btn device-table__bulk-btn--clear"
              (click)="clearSelection()"
            >
              Annulla selezione
            </button>
          </div>
        </div>
      }
      <table class="device-table">
        <thead>
          <tr>
            <th class="device-table__th device-table__th--check">
              <input
                type="checkbox"
                class="device-table__checkbox"
                [checked]="allSelected()"
                [indeterminate]="someSelected()"
                (change)="toggleSelectAll($any($event.target).checked)"
                title="Seleziona tutti"
              />
            </th>
            <th class="device-table__th device-table__th--num">U</th>
            <th class="device-table__th">Hostname</th>
            <th class="device-table__th">Modello</th>
            <th class="device-table__th">Vendor</th>
            <th class="device-table__th">Tipo</th>
            <th class="device-table__th">Seriale</th>
            <th class="device-table__th">SAP ID</th>
            <th class="device-table__th">Stato</th>
            <th class="device-table__th device-table__th--num">Size</th>
            <th class="device-table__th device-table__th--action"></th>
          </tr>
        </thead>
        <tbody>
          @for (row of deviceRows(); track row.position) {
            <tr
              class="device-table__row"
              [class.device-table__row--selected]="_selectedIds().has(row.device!.id)"
            >
              <td class="device-table__td device-table__td--check">
                <input
                  type="checkbox"
                  class="device-table__checkbox"
                  [checked]="_selectedIds().has(row.device!.id)"
                  (change)="toggleSelect(row.device!.id, $any($event.target).checked)"
                />
              </td>
              <td class="device-table__td device-table__td--num">
                {{ row.position }}
              </td>
              <td class="device-table__td device-table__td--hostname">
                {{ row.device!.device_hostname || "—" }}
              </td>
              <td class="device-table__td">
                {{ row.device!.device_model || "—" }}
              </td>
              <td class="device-table__td">
                {{ row.device!.device_vendor || "—" }}
              </td>
              <td class="device-table__td">
                <span
                  class="device-table__badge device-table__badge--{{
                    typeClass(row.device!.device_type)
                  }}"
                >
                  {{ row.device!.device_type || "—" }}
                </span>
              </td>
              <td class="device-table__td device-table__td--mono">
                {{ row.device!.device_serial_number || "—" }}
              </td>
              <td class="device-table__td device-table__td--mono">
                {{ row.device!.device_sap_id || "—" }}
              </td>
              <td class="device-table__td">
                @if (row.device!.device_state) {
                  <span
                    class="device-table__state-badge device-table__state-badge--clickable"
                    (click)="openStatePicker(+row.device!.device_id, $event)"
                    >{{ row.device!.device_state }}</span
                  >
                } @else {
                  <span>—</span>
                }
              </td>
              <td class="device-table__td device-table__td--num">
                {{ row.device!.device_rack_units }}U
              </td>
              <td class="device-table__td device-table__td--action">
                <button
                  class="device-table__remove-btn"
                  title="Rimuovi dal rack"
                  (click)="openRemoveConfirm(row.device!.id, +row.device!.device_id, $event)"
                >
                  <svg viewBox="0 0 16 16" fill="currentColor" width="13" height="13">
                    <path d="M6.5 1h3a.5.5 0 0 1 .5.5v1H6v-1a.5.5 0 0 1 .5-.5ZM11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3A1.5 1.5 0 0 0 5 1.5v1H2.506a.58.58 0 0 0-.01 0H1.5a.5.5 0 0 0 0 1h.538l.853 10.66A2 2 0 0 0 4.885 16h6.23a2 2 0 0 0 1.994-1.84l.853-10.66H13.5a.5.5 0 0 0 0-1h-.995a.59.59 0 0 0-.01 0H11Zm1.958 1-.846 10.58a1 1 0 0 1-.997.92h-6.23a1 1 0 0 1-.997-.92L3.042 3.5h9.916Zm-7.487 1a.5.5 0 0 1 .528.47l.5 8.5a.5.5 0 0 1-.998.06L5 5.03a.5.5 0 0 1 .47-.53Zm5.058 0a.5.5 0 0 1 .47.53l-.5 8.5a.5.5 0 1 1-.998-.06l.5-8.5a.5.5 0 0 1 .528-.47ZM8 4.5a.5.5 0 0 1 .5.5v8.5a.5.5 0 0 1-1 0V5a.5.5 0 0 1 .5-.5Z"/>
                  </svg>
                </button>
              </td>
            </tr>
          }
        </tbody>
      </table>
    }
  </div>
  <!-- /rack-aside -->

  <!-- ── Install panel ──────────────────────────────────────── -->
  @if (_installPos()) {
    <div class="rack-install-backdrop" (click)="closeInstall()"></div>
    <div
      class="rack-install"
      [style.top.px]="_installAnchorY()"
      [style.left.px]="_installAnchorX()"
      (click)="$event.stopPropagation()"
    >
      <div class="rack-install__header">
        <span class="rack-install__title"
          >Installa in posizione {{ _installPos() }}U</span
        >
        <button class="rack-install__close" (click)="closeInstall()">✕</button>
      </div>

      <div class="rack-install__search">
        <input
          type="text"
          class="rack-install__input"
          placeholder="Cerca per hostname, S/N, SAP…"
          [value]="_installSearch()"
          (input)="onInstallSearch($any($event.target).value)"
          autofocus
        />
      </div>

      <div class="rack-install__list">
        @if (_installAssetsState().status === "loading") {
          <div class="rack-install__loading">Caricamento…</div>
        } @else if (_installAssetsState().status === "error") {
          <div class="rack-install__empty">Errore nel caricamento</div>
        } @else if (
          installableAssets().length === 0 &&
          _installAssetsState().status === "loaded"
        ) {
          <div class="rack-install__empty">Nessun apparato da installare</div>
        } @else {
          @for (asset of installableAssets(); track asset.id) {
            <div
              class="rack-install__item"
              [class.rack-install__item--selected]="
                _installSelectedId() === asset.id
              "
              (click)="installAsset(asset.id)"
            >
              @if (asset.model.front_image) {
                <img
                  class="rack-install__thumb"
                  [src]="asset.model.front_image"
                  alt=""
                  loading="lazy"
                />
              } @else {
                <div
                  class="rack-install__thumb rack-install__thumb--empty"
                ></div>
              }
              <div class="rack-install__info">
                <span class="rack-install__hostname">{{
                  asset.hostname || "—"
                }}</span>
                <span class="rack-install__meta"
                  >{{ asset.model.name }} &middot;
                  {{ asset.model.rack_units ?? "?" }}U</span
                >
                @if (asset.serial_number) {
                  <span class="rack-install__serial"
                    >S/N: {{ asset.serial_number }}</span
                  >
                }
              </div>
            </div>
          }
        }
      </div>

      @if (_installError()) {
        <div class="rack-install__error">{{ _installError() }}</div>
      }

      <div class="rack-install__footer">
        @if (_installSaving()) {
          <span class="rack-install__saving">Installazione in corso…</span>
        }
        <button
          class="rack-install__btn rack-install__btn--cancel"
          (click)="closeInstall()"
        >
          Annulla
        </button>
      </div>
    </div>
  }
</div>
<!-- /rack-view -->

<!-- ── Bulk remove confirmation modal ────────────────────────── -->
@if (_bulkRemoveConfirm()) {
  <div class="rack-modal-backdrop" (click)="closeBulkRemoveConfirm()"></div>
  <div class="rack-modal" (click)="$event.stopPropagation()">
    @if (_bulkRemoving()) {
      <div class="rack-modal__saving">
        Rimozione in corso ({{ selectedCount() }} apparati)…
      </div>
    } @else {
      <div class="rack-modal__icon">
        <svg viewBox="0 0 20 20" fill="currentColor" width="28" height="28">
          <path fill-rule="evenodd" d="M8.485 2.495c.673-1.167 2.357-1.167 3.03 0l6.28 10.875c.673 1.167-.17 2.625-1.516 2.625H3.72c-1.347 0-2.189-1.458-1.515-2.625L8.485 2.495zM10 5a.75.75 0 01.75.75v3.5a.75.75 0 01-1.5 0v-3.5A.75.75 0 0110 5zm0 9a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/>
        </svg>
      </div>
      <p class="rack-modal__title">Rimuovere {{ selectedCount() }} apparati dal rack?</p>
      <p class="rack-modal__sub">Questa azione rimuove gli apparati selezionati dalle loro posizioni.
        @if (decommissionedStateId()) {
          Lo stato di ciascun apparato sarà impostato a <strong>Decommissionato</strong>.
        }
      </p>
      <div class="rack-modal__actions">
        <button
          class="rack-modal__btn rack-modal__btn--cancel"
          (click)="closeBulkRemoveConfirm()"
        >
          Annulla
        </button>
        <button
          class="rack-modal__btn rack-modal__btn--confirm"
          (click)="executeBulkRemove()"
        >
          Rimuovi {{ selectedCount() }} apparati
        </button>
      </div>
    }
  </div>
}

<!-- ── Remove confirmation popover ───────────────────────────── -->
@if (_removeConfirmId()) {
  <div class="rack-remove-backdrop" (click)="closeRemoveConfirm()"></div>
  <div
    class="rack-remove-confirm"
    [style.top.px]="_removeConfirmY()"
    [style.left.px]="_removeConfirmX()"
    (click)="$event.stopPropagation()"
  >
    @if (_removeSaving()) {
      <div class="rack-remove-confirm__saving">Rimozione in corso…</div>
    } @else {
      <p class="rack-remove-confirm__msg">Rimuovere l'apparato dal rack?</p>
      @if (decommissionedStateId()) {
        <p class="rack-remove-confirm__note">Lo stato sarà impostato a <strong>Decommissionato</strong>.</p>
      }
      <div class="rack-remove-confirm__actions">
        <button
          class="rack-remove-confirm__btn rack-remove-confirm__btn--cancel"
          (click)="closeRemoveConfirm()"
        >
          Annulla
        </button>
        <button
          class="rack-remove-confirm__btn rack-remove-confirm__btn--confirm"
          (click)="executeRemove()"
        >
          Rimuovi
        </button>
      </div>
    }
  </div>
}

<!-- ── State picker popover ───────────────────────────────────── -->
@if (_statePickerDeviceId()) {
  <div class="rack-state-backdrop" (click)="closeStatePicker()"></div>
  <div
    class="rack-state-picker"
    [style.top.px]="_statePickerY()"
    [style.left.px]="_statePickerX()"
    (click)="$event.stopPropagation()"
  >
    @if (_stateUpdateSaving()) {
      <div class="rack-state-picker__saving">Salvataggio…</div>
    } @else {
      @for (s of availableStates(); track s.id) {
        <button class="rack-state-picker__item" (click)="pickState(s.id)">
          {{ s.name }}
        </button>
      }
    }
  </div>
}
