<div class="map-container">
  <app-map-sidebar
    [activeTool]="selectedTool"
    [disabled]="!selectedRoomId"
    (toolChange)="onToolChange($event)"
  >
  </app-map-sidebar>
  <div class="map-content">
    <!-- Floor plan toolbar -->
    <div class="floor-plan-toolbar">
      <label for="location-select">Location:</label>
      <select
        id="location-select"
        [ngModel]="selectedLocationId"
        (ngModelChange)="onLocationSelect($event)"
      >
        <option [ngValue]="null">-- Seleziona Location --</option>
        @for (loc of availableLocations; track loc.id) {
          <option [ngValue]="loc.id">{{ loc.name }}</option>
        }
      </select>
      <label for="room-select">Room:</label>
      <select
        id="room-select"
        [disabled]="!selectedLocationId"
        [ngModel]="selectedRoomId"
        (ngModelChange)="onRoomSelect($event)"
      >
        <option [ngValue]="null">-- Seleziona Room --</option>
        @for (room of filteredRooms; track room.id) {
          <option [ngValue]="room.id">{{ room.name }}</option>
        }
      </select>
      <button
        class="btn-save"
        (click)="saveFloorPlan()"
        [disabled]="!selectedRoomId || saveStatus === 'saving'"
      >
        {{ saveStatus === "saving" ? "Salvataggio..." : "Salva Planimetria" }}
      </button>
      @if (saveStatus === "saved") {
        <span class="save-feedback save-ok">✓ Salvato</span>
      }
      @if (saveStatus === "error") {
        <span class="save-feedback save-err">✗ Errore nel salvataggio</span>
      }
      <label class="autosave-toggle">
        <input type="checkbox" [(ngModel)]="autosave" />
        <span class="switch-track">
          <span class="switch-thumb"></span>
        </span>
        <span class="switch-label">Autosalvataggio</span>
      </label>
    </div>
    <svg
      #svgContainer
      class="drawing-area"
      [class.tool-select]="selectedTool === 'select'"
      [class.tool-move]="selectedTool === 'move'"
      [style.cursor]="
        !selectedRoomId
          ? 'not-allowed'
          : isPanning
            ? 'grabbing'
            : selectedTool === 'select'
              ? 'grab'
              : ''
      "
      (mousedown)="onMouseDown($event)"
      (mousemove)="onMouseMove($event)"
      (mouseup)="onMouseUp($event)"
      (mouseleave)="onMouseUp($event)"
      (dblclick)="onDoubleClick($event)"
    >
      <!-- Grid minor 10cm (screen-space, outside transform) -->
      <path
        [attr.d]="gridPath"
        fill="none"
        stroke="#e0e0e0"
        stroke-width="0.5"
        pointer-events="none"
      />
      <!-- Grid major 1m -->
      <path
        [attr.d]="gridPathMajor"
        fill="none"
        stroke="#cdd3db"
        stroke-width="1"
        pointer-events="none"
      />

      <g [attr.transform]="svgTransform">
        @for (el of elements; track el.id) {
          <ng-container>
            <!-- Wall (Polyline) -->
            @if (el.type === "wall" && el.points) {
              <ng-container>
                <!-- Per-segment transparent hit zones in move mode -->
                @if (selectedTool === "move") {
                  @for (
                    _ of el.points.slice(0, el.points.length - 1);
                    track $index;
                    let i = $index
                  ) {
                    <line
                      [attr.x1]="el.points[i].x"
                      [attr.y1]="el.points[i].y"
                      [attr.x2]="el.points[i + 1].x"
                      [attr.y2]="el.points[i + 1].y"
                      stroke="transparent"
                      [attr.stroke-width]="16 / zoom"
                      stroke-linecap="round"
                      style="cursor: pointer"
                      (click)="onSegmentClick($event, el, i)"
                    />
                  }
                }
                <!-- Base wall polyline -->
                <polyline
                  [attr.points]="getPointsString(el.points)"
                  stroke="black"
                  [attr.stroke-width]="4 / zoom"
                  fill="none"
                  pointer-events="none"
                />
                <!-- Selected segment highlight -->
                @if (selectedSegment?.elementId === el.id) {
                  <line
                    [attr.x1]="el.points[selectedSegment!.segIndex].x"
                    [attr.y1]="el.points[selectedSegment!.segIndex].y"
                    [attr.x2]="el.points[selectedSegment!.segIndex + 1].x"
                    [attr.y2]="el.points[selectedSegment!.segIndex + 1].y"
                    stroke="#007bff"
                    [attr.stroke-width]="6 / zoom"
                    stroke-linecap="round"
                    pointer-events="none"
                  />
                }
                <!-- Wall Measurements (outside perimeter, rotated along segment) -->
                @for (seg of el.segments ?? []; track $index) {
                  <g
                    [attr.transform]="
                      'rotate(' +
                      seg.angle +
                      ',' +
                      seg.labelX +
                      ',' +
                      seg.labelY +
                      ')'
                    "
                  >
                    <text
                      [attr.x]="seg.labelX"
                      [attr.y]="seg.labelY"
                      text-anchor="middle"
                      dominant-baseline="middle"
                      fill="#666"
                      [attr.font-size]="14 / zoom + 'px'"
                      font-family="monospace"
                      pointer-events="none"
                      style="user-select: none"
                    >
                      {{ seg.length / 100 | number: "1.0-2" }} m
                    </text>
                  </g>
                }

                <!-- Wall Angles -->
                @for (angleData of el.angles ?? []; track $index) {
                  <g>
                    <text
                      [attr.x]="angleData.labelX"
                      [attr.y]="angleData.labelY"
                      text-anchor="middle"
                      dominant-baseline="middle"
                      fill="purple"
                      [attr.font-size]="12 / zoom + 'px'"
                      font-family="monospace"
                      pointer-events="none"
                      style="user-select: none"
                    >
                      {{ angleData.angle | number: "1.0-0" }}°
                    </text>
                    <!-- Small Arc for Angle -->
                    <circle
                      [attr.cx]="angleData.x"
                      [attr.cy]="angleData.y"
                      [attr.r]="12 / zoom"
                      fill="none"
                      stroke="purple"
                      [attr.stroke-width]="1 / zoom"
                      stroke-dasharray="2,2"
                      opacity="0.3"
                      pointer-events="none"
                    />
                  </g>
                }
              </ng-container>
            }
            <!-- Legacy Wall (Line) backup -->
            @if (el.type === "wall" && !el.points) {
              <ng-container>
                @if (selectedTool === "select") {
                  <line
                    [attr.x1]="el.x"
                    [attr.y1]="el.y"
                    [attr.x2]="el.x2"
                    [attr.y2]="el.y2"
                    stroke="transparent"
                    [attr.stroke-width]="16 / zoom"
                    style="cursor: pointer"
                    (click)="onElementClick($event, el)"
                  />
                }
                <line
                  [attr.x1]="el.x"
                  [attr.y1]="el.y"
                  [attr.x2]="el.x2"
                  [attr.y2]="el.y2"
                  [attr.stroke]="
                    selectedElementId === el.id ? '#007bff' : 'black'
                  "
                  [attr.stroke-width]="
                    selectedElementId === el.id ? 6 / zoom : 4 / zoom
                  "
                  pointer-events="none"
                />
              </ng-container>
            }
            <!-- Door -->
            @if (el.type === "door") {
              <ng-container>
                <line
                  [attr.x1]="el.x"
                  [attr.y1]="el.y"
                  [attr.x2]="el.x2"
                  [attr.y2]="el.y2"
                  stroke="brown"
                  [attr.stroke-width]="4 / zoom"
                  stroke-dasharray="5,5"
                  [class.selected]="selectedElementId === el.id"
                  (click)="onElementClick($event, el)"
                />
              </ng-container>
            }
            <!-- Rack -->
            @if (el.type === "rack") {
              <g
                (click)="onElementClick($event, el)"
                class="rack-group"
                [class.selected]="selectedElementId === el.id"
                [class.moving-snap]="movingElementId === el.id && rackSnapActive"
                [attr.transform]="getRackTransform(el) || null"
              >
                <rect
                  [attr.x]="el.x"
                  [attr.y]="el.y"
                  [attr.width]="el.width"
                  [attr.height]="el.height"
                  fill="#e0e0e0"
                  stroke="#333"
                  [attr.stroke-width]="1 / zoom"
                />
                <!-- Rack decorative lines (X) -->
                <line
                  [attr.x1]="el.x"
                  [attr.y1]="el.y"
                  [attr.x2]="el.x + (el.width || 0)"
                  [attr.y2]="el.y + (el.height || 0)"
                  stroke="#ccc"
                  [attr.stroke-width]="1 / zoom"
                  pointer-events="none"
                />
                <line
                  [attr.x1]="el.x + (el.width || 0)"
                  [attr.y1]="el.y"
                  [attr.x2]="el.x"
                  [attr.y2]="el.y + (el.height || 0)"
                  stroke="#ccc"
                  [attr.stroke-width]="1 / zoom"
                  pointer-events="none"
                />
                <!-- Rotation handle (drag to rotate freely; Shift snaps to 15°) -->
                @if (selectedElementId === el.id && (selectedTool === 'select' || selectedTool === 'move')) {
                  <line
                    [attr.x1]="el.x + (el.width || 0) / 2"
                    [attr.y1]="el.y"
                    [attr.x2]="el.x + (el.width || 0) / 2"
                    [attr.y2]="el.y - 26 / zoom"
                    stroke="#007bff"
                    [attr.stroke-width]="1.5 / zoom"
                    stroke-dasharray="none"
                    pointer-events="none"
                  />
                  <circle
                    class="rack-rotate-handle"
                    [attr.cx]="el.x + (el.width || 0) / 2"
                    [attr.cy]="el.y - 26 / zoom"
                    [attr.r]="6 / zoom"
                    fill="#007bff"
                    stroke="white"
                    [attr.stroke-width]="1.5 / zoom"
                    (mousedown)="onRotateHandleMouseDown($event, el)"
                  />
                }
              </g>
            }
          </ng-container>
        }

        <!-- Room area labels (planar face detection) -->
        @for (room of rooms; track $index) {
          <g [style.cursor]="selectedTool === 'move' ? 'pointer' : 'default'">
            <!-- Invisible hit target for double-click rename -->
            <rect
              [attr.x]="room.cx - 44 / zoom"
              [attr.y]="room.cy - 18 / zoom"
              [attr.width]="88 / zoom"
              [attr.height]="36 / zoom"
              fill="transparent"
              stroke="none"
              [attr.pointer-events]="selectedTool === 'move' ? 'all' : 'none'"
              (dblclick)="startEditRoom($index, $event)"
            />
            <!-- Engraved area (always visible): white highlight + main text -->
            <text
              [attr.x]="room.cx + 0.8 / zoom"
              [attr.y]="room.cy - 6.2 / zoom"
              text-anchor="middle"
              dominant-baseline="middle"
              fill="rgba(255,255,255,0.85)"
              [attr.font-size]="13 / zoom + 'px'"
              font-family="sans-serif"
              font-weight="500"
              [attr.letter-spacing]="0.5 / zoom"
              pointer-events="none"
              style="user-select: none"
            >
              {{ room.area / 10000 | number: "1.0-2" }} m²
            </text>
            <text
              [attr.x]="room.cx"
              [attr.y]="room.cy - 7 / zoom"
              text-anchor="middle"
              dominant-baseline="middle"
              fill="#5a6472"
              [attr.font-size]="13 / zoom + 'px'"
              font-family="sans-serif"
              font-weight="500"
              [attr.letter-spacing]="0.5 / zoom"
              pointer-events="none"
              style="user-select: none"
            >
              {{ room.area / 10000 | number: "1.0-2" }} m²
            </text>
            @if (editingRoomIndex !== $index) {
              <!-- Engraved name: white highlight offset + main text -->
              <text
                [attr.x]="room.cx + 0.8 / zoom"
                [attr.y]="room.cy + 7.8 / zoom"
                text-anchor="middle"
                dominant-baseline="middle"
                fill="rgba(255,255,255,0.75)"
                [attr.font-size]="10 / zoom + 'px'"
                font-family="sans-serif"
                font-style="italic"
                [attr.letter-spacing]="0.8 / zoom"
                pointer-events="none"
                style="user-select: none"
              >
                {{ room.name || "stanza" }}
              </text>
              <text
                [attr.x]="room.cx"
                [attr.y]="room.cy + 7 / zoom"
                text-anchor="middle"
                dominant-baseline="middle"
                fill="#8896a5"
                [attr.font-size]="10 / zoom + 'px'"
                font-family="sans-serif"
                font-style="italic"
                [attr.letter-spacing]="0.8 / zoom"
                pointer-events="none"
                style="user-select: none"
              >
                {{ room.name || "stanza" }}
              </text>
            }
            @if (editingRoomIndex === $index) {
              <foreignObject
                [attr.x]="room.cx - 38 / zoom"
                [attr.y]="room.cy + 1 / zoom"
                [attr.width]="76 / zoom"
                [attr.height]="16 / zoom"
              >
                <div
                  xmlns="http://www.w3.org/1999/xhtml"
                  style="
                    width: 100%;
                    height: 100%;
                    display: flex;
                    align-items: center;
                  "
                >
                  <input
                    #activeRoomInput
                    type="text"
                    [value]="editingRoomName"
                    (input)="editingRoomName = $any($event.target).value"
                    (keydown.enter)="confirmEditRoom()"
                    (keydown.escape)="cancelEditRoom()"
                    (blur)="confirmEditRoom()"
                    style="
                      width: 100%;
                      border: none;
                      border-bottom: 1px solid #8896a5;
                      outline: none;
                      text-align: center;
                      background: transparent;
                      color: #5a6472;
                      font-family: sans-serif;
                      font-style: italic;
                      font-size: 11px;
                      letter-spacing: 0.8px;
                      padding: 0;
                    "
                  />
                </div>
              </foreignObject>
            }
          </g>
        }

        <!-- Move Tool Indicators: Show all vertices as manipulatable dots when tool is active -->
        @if (selectedTool === "move") {
          <ng-container>
            @for (el of elements; track el.id) {
              <ng-container>
                @if (el.type === "wall" && el.points) {
                  <ng-container>
                    <!-- Highlight wall body to signal it's moveable -->
                    <polyline
                      [attr.points]="getPointsString(el.points)"
                      stroke="rgba(255,140,0,0.3)"
                      [attr.stroke-width]="10 / zoom"
                      fill="none"
                      style="cursor: grab"
                      pointer-events="none"
                    />
                    <!-- Vertex handles -->
                    @for (p of el.points; track $index; let i = $index) {
                      <circle
                        [attr.cx]="p.x"
                        [attr.cy]="p.y"
                        [attr.r]="6 / zoom"
                        [attr.fill]="
                          hoveredVertex &&
                          hoveredVertex.elementId === el.id &&
                          hoveredVertex.pointIndex === i
                            ? 'red'
                            : 'orange'
                        "
                        stroke="white"
                        [attr.stroke-width]="2 / zoom"
                        style="cursor: grab"
                        pointer-events="none"
                      />
                    }
                  </ng-container>
                }
              </ng-container>
            }
          </ng-container>
        }

        <!-- Snap-to-vertex indicator (green ring when dragging a vertex near another wall's vertex) -->
        @if (snapTargetVertex) {
          <circle
            [attr.cx]="snapTargetVertex.x"
            [attr.cy]="snapTargetVertex.y"
            [attr.r]="14 / zoom"
            fill="none"
            stroke="#00cc44"
            [attr.stroke-width]="2.5 / zoom"
            stroke-dasharray="4,2"
            pointer-events="none"
          />
          <circle
            [attr.cx]="snapTargetVertex.x"
            [attr.cy]="snapTargetVertex.y"
            [attr.r]="3 / zoom"
            fill="#00cc44"
            pointer-events="none"
          />
        }

        <!-- Vertex Snap Indicator (Blue Dot) — visible also before drawing starts -->
        @if (selectedTool === "wall" && vertexSnapPoint) {
          <circle
            [attr.cx]="vertexSnapPoint.x"
            [attr.cy]="vertexSnapPoint.y"
            [attr.r]="8 / zoom"
            fill="#007bff"
            stroke="white"
            [attr.stroke-width]="2 / zoom"
            pointer-events="none"
          />
        }
        <!-- Edge Snap Indicator (Orange ring + dot) — visible also before drawing starts -->
        @if (selectedTool === "wall" && edgeSnapPoint) {
          <circle
            [attr.cx]="edgeSnapPoint.x"
            [attr.cy]="edgeSnapPoint.y"
            [attr.r]="7 / zoom"
            fill="none"
            stroke="#ff8c00"
            [attr.stroke-width]="2 / zoom"
            pointer-events="none"
          />
          <circle
            [attr.cx]="edgeSnapPoint.x"
            [attr.cy]="edgeSnapPoint.y"
            [attr.r]="3 / zoom"
            fill="#ff8c00"
            pointer-events="none"
          />
        }

        <!-- Current drawing element preview -->
        @if (isDrawing) {
          <ng-container>
            <!-- Polyline Preview -->
            @if (selectedTool === "wall" && activePolylinePoints.length > 0) {
              <ng-container>
                <polyline
                  [attr.points]="polylinePreviewPoints"
                  stroke="black"
                  [attr.stroke-width]="4 / zoom"
                  fill="none"
                  opacity="0.6"
                  pointer-events="none"
                />
                <!-- Dimension Line and Text -->
                @if (activePolylinePoints.length > 0) {
                  <g pointer-events="none">
                    <!-- Dimensions for already drawn segments of the current polyline -->
                    @for (segment of activeWallSegments; track $index) {
                      <g
                        [attr.transform]="
                          'rotate(' +
                          segment.angle +
                          ',' +
                          segment.labelX +
                          ',' +
                          segment.labelY +
                          ')'
                        "
                      >
                        <!-- Length Text Background -->
                        <rect
                          [attr.x]="segment.labelX - 20 / zoom"
                          [attr.y]="segment.labelY - 9 / zoom"
                          [attr.width]="40 / zoom"
                          [attr.height]="18 / zoom"
                          fill="white"
                          fill-opacity="0.8"
                          [attr.rx]="3 / zoom"
                        />
                        <text
                          [attr.x]="segment.labelX"
                          [attr.y]="segment.labelY"
                          text-anchor="middle"
                          dominant-baseline="middle"
                          fill="#333"
                          [attr.font-size]="12 / zoom + 'px'"
                        >
                          {{ segment.length / 100 | number: "1.0-2" }} m
                        </text>
                      </g>
                    }
                    <!-- Dashed line for current segment (cursor) -->
                    <line
                      [attr.x1]="
                        activePolylinePoints[activePolylinePoints.length - 1].x
                      "
                      [attr.y1]="
                        activePolylinePoints[activePolylinePoints.length - 1].y
                      "
                      [attr.x2]="cursorPosition.x"
                      [attr.y2]="cursorPosition.y"
                      stroke="#666"
                      [attr.stroke-width]="1 / zoom"
                      stroke-dasharray="4,4"
                    />
                    <!-- Length Text Background -->
                    <rect
                      [attr.x]="
                        (activePolylinePoints[activePolylinePoints.length - 1]
                          .x +
                          cursorPosition.x) /
                          2 -
                        20 / zoom
                      "
                      [attr.y]="
                        (activePolylinePoints[activePolylinePoints.length - 1]
                          .y +
                          cursorPosition.y) /
                          2 -
                        10 / zoom
                      "
                      [attr.width]="40 / zoom"
                      [attr.height]="20 / zoom"
                      fill="white"
                      fill-opacity="0.8"
                      [attr.rx]="4 / zoom"
                    />
                    <!-- Length Text -->
                    <text
                      [attr.x]="
                        (activePolylinePoints[activePolylinePoints.length - 1]
                          .x +
                          cursorPosition.x) /
                        2
                      "
                      [attr.y]="
                        (activePolylinePoints[activePolylinePoints.length - 1]
                          .y +
                          cursorPosition.y) /
                          2 +
                        4 / zoom
                      "
                      text-anchor="middle"
                      fill="#333"
                      [attr.font-size]="12 / zoom + 'px'"
                      font-weight="bold"
                    >
                      {{ currentSegmentLength / 100 | number: "1.0-2" }} m
                    </text>
                    <!-- Angle Text at Vertices -->
                    @for (angleData of previewAngles; track $index) {
                      <ng-container>
                        <text
                          [attr.x]="angleData.labelX"
                          [attr.y]="angleData.labelY"
                          text-anchor="middle"
                          dominant-baseline="middle"
                          fill="purple"
                          [attr.font-size]="11 / zoom + 'px'"
                          font-weight="bold"
                        >
                          {{ angleData.angle | number: "1.0-0" }}°
                        </text>
                        <!-- Short Arc Helper (Optional) -->
                        <circle
                          [attr.cx]="angleData.x"
                          [attr.cy]="angleData.y"
                          [attr.r]="15 / zoom"
                          fill="none"
                          stroke="purple"
                          [attr.stroke-width]="1 / zoom"
                          stroke-dasharray="2,2"
                          opacity="0.5"
                        />
                      </ng-container>
                    }
                  </g>
                }
                <!-- Intersection Indicator (Red Dot) -->
                @if (intersectionPoint) {
                  <circle
                    [attr.cx]="intersectionPoint.x"
                    [attr.cy]="intersectionPoint.y"
                    [attr.r]="6 / zoom"
                    fill="red"
                    stroke="white"
                    [attr.stroke-width]="2 / zoom"
                    pointer-events="none"
                  />
                }
                <!-- Start point indicator for closing -->
                <circle
                  [attr.cx]="activePolylinePoints[0].x"
                  [attr.cy]="activePolylinePoints[0].y"
                  [attr.r]="5 / zoom"
                  fill="green"
                  opacity="0.5"
                  pointer-events="none"
                />
              </ng-container>
            }
            @if (currentElement && currentElement.type !== "wall") {
              <ng-container>
                @if (currentElement.type === "door") {
                  <line
                    [attr.x1]="currentElement.x"
                    [attr.y1]="currentElement.y"
                    [attr.x2]="currentElement.x2"
                    [attr.y2]="currentElement.y2"
                    stroke="brown"
                    [attr.stroke-width]="4 / zoom"
                    stroke-dasharray="5,5"
                    opacity="0.5"
                  />
                }
                @if (currentElement.type === "rack") {
                  <rect
                    [attr.x]="currentElement.x"
                    [attr.y]="currentElement.y"
                    [attr.width]="currentElement.width"
                    [attr.height]="currentElement.height"
                    [attr.fill]="rackCreationBlocked ? '#ffcccc' : '#e0e0e0'"
                    [attr.stroke]="
                      rackCreationBlocked
                        ? '#cc0000'
                        : rackSnapActive
                          ? '#00aacc'
                          : '#333'
                    "
                    [attr.stroke-width]="
                      (rackCreationBlocked || rackSnapActive ? 2 : 1) / zoom
                    "
                    [attr.stroke-dasharray]="
                      rackCreationBlocked ? 4 / zoom + ',' + 3 / zoom : 'none'
                    "
                    opacity="0.6"
                  />
                }
              </ng-container>
            }
          </ng-container>
        }
      </g>
    </svg>
    <!-- Zoom Controls -->
    <div class="zoom-controls">
      <button class="zoom-btn" (click)="zoomIn()" title="Zoom in">+</button>
      <button class="zoom-btn" (click)="fitToView()" title="Adatta alla vista">
        ⊡
      </button>
      <button
        class="zoom-btn zoom-reset"
        (click)="resetZoom()"
        title="Reset zoom"
      >
        {{ zoom * 100 | number: "1.0-0" }}%
      </button>
      <button class="zoom-btn" (click)="zoomOut()" title="Zoom out">−</button>
    </div>
  </div>
</div>
